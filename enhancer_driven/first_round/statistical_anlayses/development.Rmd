---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup 

```{r}

"%&%" <- function(a,b) paste0(a,b)
library("data.table")
library("tidyverse")


serv.dir1 <- "/home/jason/science/servers/FUSE5/"
serv.dir2 <- "/home/jason/science/servers/FUSE6/"
source(serv.dir2 %&% "peakC/R/reading_functions.R")
source(serv.dir2 %&% "peakC/R/util_functions.R")
#source(serv.dir2 %&% "peakC/manually_added/experiment_comparison.R")
bg.dir <- serv.dir2 %&%
  "CaptureCompare/FirstRound_cis_analysis/3_unionBedgraphs/"


```


```{r}

prepare_input_list <- function(bg.df,vp,region.size=1e6,keep.cols=c(4,5,6)){
  flank = region.size/2
  sub <- filter(bg.df,V2>=(vp-flank),V3<=(vp+flank))
  
  # Note in union bedgraph, columns 4,5,6 correspond to Endos whereas 7,8,9 are hESC
  sub <- sub[,c(2,keep.cols)]
  df1 <- sub[,c(1,2)]; df2 <- sub[,c(1,3)]; df3 <- sub[,c(1,4)]
  names(df1) <- c("frag_pos","frag_score");names(df2) <- c("frag_pos","frag_score");
  names(df3) <- c("frag_pos","frag_score")
  l <- list(df1,df2,df3)
  return(l)
}

mean_mat <- function(bg.df,vp,region.size=1e6,keep.cols=c(4,5,6)){
  # take union bedgraph and get mean signal per fragment 
  # Note in union bedgraph, columns 4,5,6 correspond to Endos whereas 7,8,9 are hESC
  flank = region.size/2
  sub <- filter(bg.df,V2>=(vp-flank),V3<=(vp+flank))
  sub <- sub[,c(2,keep.cols)] 
  vec <- c()
  pb <- txtProgressBar(min=0,max=dim(sub)[1],style=3)
  for (i in 1:dim(sub)[1]){
    setTxtProgressBar(pb,i)
    val <- sub[i,c(2:4)] %>% as.numeric(.) %>% mean(.)
    vec <- append(vec,val)
  }
  m <- cbind(sub[,1],vec) %>% as.matrix(.)
  colnames(m) <- c("frag_pos","frag_sig")
  return(m)
}

```

```{r}

runmean.perm <- function ( x1, x2, k = 21, iter = 1000 ){
  X <- matrix(NA, ncol=iter, nrow=length(x1)-k+1)
  for(i in 1:iter){
    #randomly select a value from one of the two experiments
    X[,i] <- running(ifelse(runif(length(x1)) > 0.5, x1, x2), k)
  }
  return(X)
}

running <- function(x,n=20){
  cumsum(x)->sum.v
  sum.v<-c(0,sum.v)
  #(sum.v[(n+1):length(x)]-sum.v[1:(length(x)-n)])/n
  diff(sum.v,n)/n
}

compare.data <- function( x1, x2, wSize = 21, cut.off = 0.997, abs.cut.off = 500, vp.pos = 0, vp.dist=0){
  #check whether x1 and x2 contain the same fragments
  #if not select the overlapping fragments
  x1 <- x1[x1[,1]%in%x2[,1],]
  x2 <- x2[x2[,1]%in%x1[,1],]
  
  shuffle.profile <- runmean.perm(x1[,2], x2[,2], k = wSize)
  #this is written somewhat counter-intuitively:
  #if shuffle profile is higher than the running mean of x2 in more then
  #cut.off fraction of the cases, this mean that x1 is up
  #and vice versa
  #up.i <- which(apply(shuffle.profile > running(x2[,2],wSize), 1, mean) > cut.off)
  #down.i <- which(apply(shuffle.profile < running(x2[,2],wSize), 1, mean) > cut.off)
  #alternative less counter-intuitive way
  up.i   <- which(apply(running(x1[,2],wSize) > shuffle.profile, 1, mean) > cut.off | apply(running(x2[,2],wSize) < shuffle.profile, 1, mean) > cut.off)
  down.i <- which(apply(running(x2[,2],wSize) > shuffle.profile, 1, mean) > cut.off | apply(running(x1[,2],wSize) < shuffle.profile, 1, mean) > cut.off)
  x1.run <- running(x1[,2],wSize)
  x2.run <- running(x2[,2],wSize)
  diff.x <- abs(x1.run[up.i] - x2.run[up.i])
  up.i <- up.i[diff.x > abs.cut.off]
  diff.x <- abs(x1.run[down.i] - x2.run[down.i])
  down.i <- down.i[diff.x > abs.cut.off]
  
  up.pos <- rem(x1[,1],wSize)[up.i]
  down.pos <- rem(x1[,1],wSize)[down.i]
  if(vp.dist > 0){
    up.pos <- up.pos[up.pos < vp.pos-vp.dist | up.pos > vp.pos + vp.dist]
    down.pos <- down.pos[down.pos < vp.pos-vp.dist | down.pos > vp.pos + vp.dist]
  }
  if(length(up.pos) > 0){
    up <- data.frame(pos=up.pos, col=1)
  }else{
    up <- data.frame()
  }
  if(length(down.pos) > 0){
    down <- data.frame(pos=down.pos, col=2)
  }else{
    down <- data.frame()
  }
  rbind(up, down)
}
```


```{r}

run_peakC <- function(bg.df,vp,region.size=1e6,winsize=11,fdr=0.05,abscutoff=100){
  # first list object is list of modeled results, 
  # second list object is a data frame from comparative analysis
  l1 <- prepare_input_list(bg.df,vp,region.size,keep.cols=c(4,5,6)) # Endos 
  m1 <- mean_mat(bg.df,vp,region.size,keep.cols=c(4,5,6))
  l2 <- prepare_input_list(bg.df,vp,region.size,keep.cols=c(7,8,9)) # hESC
  m2 <- mean_mat(bg.df,vp,region.size,keep.cols=c(7,8,9))
  results.modeled <- combined.analysis(data=l1,num.exp=3,vp.pos=vp,wSize=winsize,alphaFDR=fdr)#PeakC modeled 
  results.compared <- compare.data(x1=m1,# EndoC
                                    x2=m2, # hESC 
                                    wSize=winsize, vp.pos=vp, abs.cut.off=abscutoff)  # PeakC comparative
  return(list(results.modeled,results.compared))
}


```


```{r}

test.df <- fread(bg.dir %&% "rs59153558_HMG20A__8QTL__eQTL__chr15_77806770.unionbdg") %>% as.data.frame(.)
vp = 77808771
res <- run_peakC(test.df,vp,region.size = 1e6,winsize=11,abscutoff = 100)

```



